# 减少页面资源

减少页面请求资源的数量是性能优化中的「黄金原则」，是搭建最快页面过程中最重要的优化手段。如果你只有时间对其中一个部分进行优化，则请毫不犹豫地选择这一部分。

就像常识一样，更少的页面资源 - 如更少的图片、脚本和样式，会使页面变得更轻量，因此加载会更快。但减少页面资源并不意味着减少页面的特色或功能。本章（或本书）一开始就假设需要优化的页面在进行优化之后会保留原有的设计和所有的功能。

为了有效地让各位更深入地了解性能优化中的艺术和科学，本章还会介绍类似 HTTP 和 TCP/IP 协议等的技术细节。如果这些部分让你感到措手不及，请别慌，你可以慢慢理解和吸收。

## 瀑布流

为了优化页面的加载时间，首先必须了解整个页面是怎么运作的 - 浏览器是怎么加载页面的？哪些过程可能拖慢了加载进度？如果不先了解这些问题，漫无目的的优化只会浪费时间；反正针对这些部分的优化则会更有效果。

一般来说，了解页面加载的过程 - 指的是从输入 URL 开始到浏览器加载完整个页面的过程，也是非常有用的。

为了更清晰地描述当页面加载时浏览器后台会发生什么事情，很多浏览器都提供了一个叫「瀑布流」的可视化工具。距两个例子：

* 在 Firefox 中，可以从 Firebug 的「网络」（Net）标签调出瀑布流工具（**图 3.1.**）
* 低版本的 Internet Explorer 可以用在线工具 WebPageTest.org 查看瀑布流（**图 3.2.**），这样免安装任何插件。[译者注：IE9 开始可以查看网络瀑布流]

![Firebug 网络标签下的瀑布流工具](http://img02.taobaocdn.com/tps/i2/T16MVrXAdfXXaRud.7-800-421.jpg "Firebug 网络标签下的瀑布流工具")

*图 3.1. Firebug 网络标签下的瀑布流工具*

![WebPage Test 对 twitter.com 产生的瀑布流](http://img02.taobaocdn.com/tps/i2/T1bo0qXBdhXXX_JF_4-727-618.png "WebPage Test 对 twitter.com 产生的瀑布流")

*图 3.2. 在 WebPage Test 访问 twitter.com 产生的瀑布流*

**图 3.2. **显示了在 WebPageTest 上用 IE7 打开 twitter.com 所生成的瀑布流。可以看到，HTML 文档是最先开始下载的，然后紧接着下载其它被页面引用的资源，也包括子资源所引用的资源（如 CSS 文件中引用的背景文件）。从图中可以看出，所有资源并不是同时下载的。事实上上面这张图只是一部分的截图，瀑布流会一直增长知道页面所有资源都下载完成。这样一张由各个资源下载进程组成的图的确很像一个「瀑布」。

从图中可以看出，twitter.com 的 HTML 文档只用了不到一秒的时间就下载完成，但其它资源一起却花费了超过四秒的时间。在这个例子中，就像大多数网站那样，也适用经典的 80/20 法则：页面自身文档的下载只占用了 20% 的时间，其余时间都消耗在下载其它资源上面。所以我们更应该把时间花在优化正确的部分上，因为优化 80% 的一半和优化 20% 的一半带来的结果明显是不一样的。

## HTTP 请求

在瀑布流中每个资源的请求都对应着一条彩色的条形。每个条形代表着一个请求，而里面不一样的颜色则代表着一个特定的过程。条形的总长或里面各个颜色所占长度则代表着它们所消耗的时间。接着我们深入分析一下各个颜色代表的过程，以 Twitter 的 HTML 文档为例（**图 3.3.**）

![一个 HTTP 请求](http://img02.taobaocdn.com/tps/i2/T1q_tqXz4hXXXjwZzV-395-19.png "一个 HTTP 请求")

*图 3.3. 一个 HTTP 请求*

* 深绿色代表查询 DNS 所消耗的时间。DNS（Domain Name Service 域名查询服务）查询的过程是指把 twitter.com 对应成 IP 地址（如 128.242.240.20）的过程，这是浏览器访问服务器必需的一个过程。就像查号码本一样，浏览器只知道名字（域名），但它需要的是号码（IP 地址）。
  
  在**图 3.2. **中可以看到每个域名都有一个 DNS 查询的过程（twitter.com, a1.twimg.com, a3.twimg.com, s.twimg.com），这是因为每个子域名都可能各自在不同的服务器上，拥有不同的 IP 地址。
  
* 橙色代表浏览器与服务器建立链接所需要的时间。我们接下来只会谈其中一部分。

* 亮绿色代表着 TTFB（time-to-first byte，第一字节达到时间），是指浏览器等待服务器返回的第一个字节所需要的时间。很大多数情况下服务器需要时间去组合和完成页面的代码。如果去优化服务端脚本和数据库的话，所优化的时间就会在这一阶段体现。可以明显看出，相对于其它部分来说，这一部分不值得专注，因为它带来的影响是微乎其微的（当然除非服务端出了什么严重差错）[译者注：作者认为这一部分的优化没有其它部分重要，但在我看来也十分重要，因为明显这一部分占用的时间是最多的]

* 蓝色就代笔着实际下载所需要的时间

纵观整个图表，会发现蓝色部分并不多。这意味着大多数时间并不花在实际下载上面。

## 有关网速的误区

你可以听到过这样的话：『现在每个人都用宽带啦巴拉巴拉』或者『我们的目标用户都是专业网民，他们都有很快的网络。』这些都是懒得去优化网站的借口，实质就是对用户的不负责任。这里有几个关于「网速理论」的误区。

首先，无论是美国还是美国以外，仍有大量用户使用低速网络[译者注：作者是美国人]。部分用户仍在使用调制解调器连接网络，而且更多用户在使用智能手机上网，他们的网络或者慢或者不稳定。其他人则可能是在咖啡店或家里跟别人共享 WiFi 网络。实际上要拖慢共享 WiFi 链接速度的方法很简单，只要有个人再视频聊天或者你家微波炉开了，下载速度就会受到很大影响。

此外，一个不多人知道的事实是，一般 ISP（Internet Service Provider 网络服务提供商[译者注：如电信、联通]）所提供的上载速度只有总带宽的 20% 左右，这不仅仅影响着大文件的上传，普通的请求也受到此限制。

最后，如你所见，瀑布流中大部分的时间被花在其它阶段上而不是实际的下载过程，然而网速的快慢只能对蓝色的下载过程有点帮助。

### 「线路管道」

你可以听说过一个恶搞的词叫 intertubes（互联管道），用以描述互联网的构造布局。这虽然是不正确的，但这个概念仍可以类比成「带宽」。如果把调制解调器线路类比成一条普通的胶管，那宽带线路则是一条有更大直径的「粗」胶管，即「宽」带。

在这些「胶管」里面流动的是数据包。每个文件会被分成一堆数据包进行发送。数据包以 2/3 光速传输 - 已经非常快了，而且能改进的空间很小。「粗胶管」意味着同一时间内允许更多和更大的数据包进行传送，反之「细胶管」能同时传送的数据包更小也更少，导致数据包按顺序排列陆续发送，传输速度变慢。

但实际上「胖胶管」的优势并不大，你可以接受这个事实然后继续阅读下一节，抑或继续让自己停留在了解皮毛的阶段。

### 文件传输

在文件传输初始化之前，浏览器和服务器之间要建立一条链接。建立链接所花费的时间在瀑布流图表中用了橙色来表示。

> ## TCP/IP
> IP 协议通过网络把信息（数据包）从一台电脑传送至另外一台电脑。TCP 协议模糊了数据包在终端间解包和组装的细节。TCP 协议用一些头信息描述每个数据包里面的内容。SYN 和 ACK 就是类似的头信息。SYN（序列号）用来分辨不同数据包让相同的信息能组合在一起，因为现实中的网络其实是非常混乱的，有些数据包的达到顺序可能错乱。ACK 意思是 「Acknowledged」（已收到），表示接受方已经接收到信息，并做出答应的回复。

一个新的链接（**图 3.4.**）通过三次握手建立：

![三次握手](http://img03.taobaocdn.com/tps/i3/T1WIJuXqldXXat2v_O-721-225.png "三次握手")

*图 3.4. 三次握手*

* 浏览器发送一个带有序列号的 SYN 数据包
* 服务器接收后返回 ACK 数据包，并再发送一个 SYN 数据包
* 浏览器响应 ACK 数据包，现在两方都已相互认识，可以相互「聊天」了（传输数据）

这些握手数据包非常小，它们以相同的速度传输，受线路带宽的影响并不大。用户即使有很快的网速，但在这一阶段网速并不会带来优势。

一旦链接建立，文件（比如一张图片）的实际传输过程就会开始。文件一般会根据其大小被分割成一系列的数据包。服务器每发送一个数据包就会等 ACK 响应返回。ACK 响应也可以额外地附带一些如「嗨，其实我可以接收更大块的数据包」，然后服务器就响应之并发送更大的数据包。这个过程会重复几次，直到整个线路「饱和」，数据包的大小达到最合适的状态。这是现实中我们看到的下载速度一开始都很慢的原因，这也说明了宽带并没有我们想象中那么重要。高速网络会对下载大文件有很大帮助，但对于不同域名下的一堆小文件（每个都需要 DNS 查询、建立链接、链接一开始是很慢的），网速并没有太大的效用。

对于整个网络传输环境，你可以把它看作是一个错综复杂的森林。浏览器和客户端之间其实并没有真正「面对面」的交流，它们之间参杂着各种的 ISP 和代理服务器等等。很多意想不到的事情会在这个森林中发生，导致传输速度损失。有时候是数据包丢失，或者数据包在传输过程中被哪个阿瘪给扔了。这种情况服务器不会收到 ACK 响应，在超过一定时间后，服务器就会发送这个数据包。再或者有些时候客户端被太多的数据包给「堵住」了（想象一下移动设备没内存了），没法再处理和响应 ACK 数据。这也是现存 TCP 通信开始的时候都很慢的原因 - 服务器总是不能预先知道对方是哪个客户端，每次都需要三次握手才能继续通信。

NetMon 是一个 Window 下的工具，可以从数据包层面监听和查看系统里的网络活动。另一个来自微软的工具 VRTA（Visual RoundTrip Analyer 可视化路由分析），基于 NetMon，可以更友好地用图表表现数据。**图 3.5.** 就是一个请求的例子，可以看出 TCP 请求开始的时候是最慢的。蓝色的条形慢慢增高表示在慢慢地打开 TCP 链路的带宽。紫色的条形则代表着建立链接，灰色是 TTFB。**图 3.6.** 是鼠标移到 VRTA 上显示的一些信息，你可能认得前面三行就是那三个握手数据包。

![VRTA 里面的一个请求](http://img03.taobaocdn.com/tps/i3/T1PVVtXxBeXXbtDnrr-360-116.png "VRTA 里面的一个请求")

*图 3.5. VRTA 里面的一个请求，可以更直观地看出 TCP 请求开始时很慢*

![VRTA 里的数据包列表](http://img02.taobaocdn.com/tps/i2/T1QCltXvtdXXbDEozc-455-148.png "VRTA 里的数据包列表")

*图 3.6. VRTA 里的数据包列表*

最后，给网速神话致命一击的事实 - 大多数浏览器只支持对同一个域名同时建立两个链接。这意味着只有两个文件在同时下载，造成网速的浪费。不过因为这是 HTTP 标准决定的，所以我们倒不能责怪浏览器们。问题是这些标准是在很久之前就制定的。不过幸运的是，黑暗尽头总有光 - 新浏览器（Firefox 3+，Safari 4+，Chrome，Opera 10+，IE8+）提供了 6 到 8 个并发链接。但还占有大部分市场份额的低端浏览器如 IE6-7 仍然只有两个。

### 总结一下

我们总结一下为什么大量 HTTP 请求（即大量页面资源请求）是罪孽的，而且为什么网速并不是解决性能问题的最好方案：

* 每个 HTTP 请求都带有额外的信息
* 下载文件实际所需要的时间只占请求时间的一小部分
* 高速网络只对下载文件的时间有帮助，尤其是大文件
* 网速对其它过程并没有太大的影响，如 DNS 查询、建立链接、TTFB
* 「宽」带实际上并没有完全发挥它的优势
* 浏览器限制了每个域名下的并发连接数
* 大量的用户（如移动用户）并没有使用宽带或者高速网络


## 有关缓存的误区

你可能觉得整个 TCP 嘛嘛的是一件很神奇的东西（虽然有点枯燥），但你可能也会怀疑这些东西真的有用吗？页面的资源如图片和样式文件，在第一次访问过页面之后，所有的东西不是经常放在缓存中了吗？

然而事实就是，「都在缓存里」是另一个误解。实际上很多原因会导致大部分用户访问网站时是不带任何缓存的。

来自雅虎前台页面的一个实验数据表明：

* 40% - 60% 的日常用户访问时没有带任何缓存
* 20% 的页面访问都是不带任何缓存的访问

鉴于 yahoo.com 是一个非常出名的门户网站而且它是很多用户的默认首页，这已经能推翻「用户访问时总是带着缓存」这一观点了。结果真让人丧气，有约一半的用户今天访问过网站之后明天再访问时缓存就不见了。

那究竟为什么这么多空缓存？其中涉及的原因有很多：用户自行清空了缓存，浏览器在关闭时自动清除，或者杀毒软件清空了等等。再或者缓存满了，在第二次访问前它就被删除了。大多数浏览器有 50MB 的缓存空间，实际上这个容量并没有你想象中那么大，尤其是访问现在那些都是富媒体的页面，而且我们现在的上网习惯也会让这个容量十分不足（因为相对于几年前，我们在网上待更长时间，打开的页面更多）。

因此，时刻为未缓存页面优化是十分重要的。本章结尾会提到怎么改善缓存效果。


## 合并脚本和样式

到现在为止，你应该清除的知道页面发出越多的请求，就会有更多额外的消耗，导致页面越慢。减少页面的 HTTP 请求则是最好的加速方法。

让我们来看一下具体怎么减少资源请求。当然，也许最简单的方法是从页面中剔除某些功能，但我们需要的是保持同样的设计和页面功能而把页面加速。所以剩下的方法就是把已有的页面资源整合在一起，以减少独立请求。

一般来说，一个页面上会引用好几个 Javascript 脚本和 stylesheets 样式文件。这种情况对开发带来很大便利，但发布到线上时就要分别把所有 Javascript 文件和 CSS 文件合并成一个文件。

举个例子，一个页面使用了 jQuery 框架和两个 jQuery 插件，还包括一些专门给这个页面编写的非框架代码。然后这个页面的代码的一部分就像是这样的：

    <script src="js/jquery.js" type="text/javascript"></script>
    <script src="js/jquery.form.js" type="text/javascript"></script>
    <script src="js/jquery.lightbox.js" type="text/javascript"></script>
    <script src="js/myapplication.js" type="text/javascript"></script>

接着我们新建一个 all.js 把上面所有脚本文件的内容合并在一起，这样就需要一个 script 标签：

    <script src="js/all.js" type="text/javascript"></script>
    
这样我们就节省了三个 HTTP 请求，页面加载变得更快。第六章会详细介绍怎么优化 Javascript 脚本，其中提到它们的加载受浏览器行为影响，会按顺序逐个下载，导致拖慢整个瀑布流。因此，确保页面内有最少的脚本文件是非常必要的。

在合并脚本文件之后，我们重复一遍相同的操作来合并样式。这样只需要一个样式文件：
     
    <link href="all.css" type="text/css" rel="stylesheet" />
     
一个页面一般会分出几个媒体类型的样式（media stylesheets），但毫无例外这些不同媒体类型的样式都需要合并，放进 `@media print {…}` 声明里面。第八章我们会更详细地介绍优化 CSS 以提高渲染效率的方法，另外有个地方很让人好奇，就是一旦媒体类型是 print 的样式没加载之前，页面不会渲染任何东西。

[译者注：这一段有很多错误的地方。首先不同媒体类型的样式不应该直接合并在`@media print`，媒体类型选择器并不能嵌套，但可以把不同媒体类型放在同一个 CSS 文件。第二，浏览器只会阻塞影响此页面的样式文件，对于一般 PC 来说，浏览器会等待媒体类型为空或「all」或「screen」的样式加载完成才开始渲染，并不是「print」]

合并资源文件的另外一个好处是合并后的文件大小比合并前小文件大小的总和要更小，因为一般合并时会使用压缩，这一部分会在下一章介绍。


### 缺点和解决方法

很多优化手段都有它们各自的弊端，而大多数就是优化后可能会带来开发上的不便利。想象一下忙活了一整天，修复了很久 IE6 下的 bug，准备发布代码上线前，还要一个一个地手动把各种资源打包在一起，那是多痛苦的事。实际上合并和打包这些琐碎的操作可以用一些自动化代码完成，它甚至可以帮你直接把代码发布到线上。另一种选择就是用服务端脚本（一般叫自动打包脚本）去按需打包，自动打包脚本可以根据一定条件从一堆资源文件或代码中提取符合条件的进行打包。例如，YUI（Yahoo! User Interface）框架就使用了类似的服务端自动打包脚本，只合并所需要的文件。最后的 URL 是类似这样的：

    http://yui.yahooapis.com/combo?3.0.0/build/yui/yui-min.js&3.0.0/build/oop/oop-min.js&3.0.0/build/event-custom/event-custom-min.js
    
> ## HTTP 过期参数（Expires)
> 为打包后的文件设置合适的 HTTP 过期时间是很重要的，以保持更好的缓存效果。因为一般脚本文件并不会缓存。有关 Expires 的介绍会在后面提到，这里给出了用 PHP 设置合理的 Expires 参数的方法：
>>`$expiration = mktime() + 60 * 60 * 24 * 365 * 10; // 加上 10 年的时间
>> header('Expires: ' . gmdate('D, d M Y h:m:s', $expiration) . ' GMT');`




































